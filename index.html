<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIB Ads WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap'); 

        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Vazirmatn', Arial, Helvetica, sans-serif;overflow:hidden;background: #0d0c1d;}
        
        .app-screen {
            position: fixed;
            inset: 0;
            background: url('img.png') no-repeat center center;
            background-size: cover;
            transition: opacity .5s ease-in;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none; 
            z-index: 10; 
        }
        .app-screen.visible {
            opacity: 1;
            pointer-events: auto;
            z-index: 20; 
        }

        /* Loading Screen - Neon enhancements */
        .loading-screen{
            position:fixed;inset:0;
            background: #0d0c1d;
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            z-index:9999;transition:opacity .5s ease-out;
        }
        .loading-screen.hidden{opacity:0;pointer-events:none}
        .loading-content{text-align:center;color:#fff}
        .progress-container{
            width:300px;height:12px;background:rgba(255,255,255,.05);
            border-radius:10px;overflow:hidden;margin:2.5rem 0;
            box-shadow:0 0 15px rgba(0,255,255,0.4);
            border:2px solid #00ffff;
        }
        .progress-bar{
            height:100%;
            background:linear-gradient(90deg, #00ffff 0%, #00bfff 100%);
            border-radius:8px;width:0;transition:width .4s ease;position:relative;overflow:hidden;
        }
        .progress-bar::after{content:'';position:absolute;top:0;left:0;bottom:0;right:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);animation:shimmer 1.5s infinite}
        @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
        .percentage{
            font-size: 2.5rem; 
            font-family:'Orbitron', sans-serif; 
            color:#fff;margin-top:1rem;
            text-shadow:0 0 10px #00ffff, 0 0 20px rgba(0,255,255,0.8);
            letter-spacing: 2px;
        }
        .loading-text{
            font-size:1.2rem;color:rgba(255,255,255,.9);margin-top:1rem;text-shadow:0 1px 2px rgba(0,0,0,.5);
            animation: pulse 1.5s infinite alternate;
        }
        @keyframes pulse {
            0% { opacity: 0.7; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.05); }
        }

        /* Main Screen */
        .main-screen{
            background-color: #f0f0f0; 
        }
        
        .main-content{flex:1;display:flex;justify-content:center;align-items:center}
        
        /* User Circle */
        .user-circle{
            position:absolute;top:20px;left:20px;width:70px;height:70px;border:2px dashed #ccc;
            border-radius:50%;display:flex;flex-direction:column;justify-content:center;
            align-items:center;cursor:pointer;transition:all .3s ease;z-index:100;overflow:hidden
        }
        .user-circle:hover{border-color:#4a90e2;background:rgba(74,144,226,.05)}
        .user-circle img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none}
        .user-circle .placeholder{color:#999;font-size:12px;text-align:center}
        
        .user-username{
            position: absolute;
            top: 95px;
            left: 20px;
            width: 70px;
            font-size:13px;color:#555;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-id{
            position: absolute;
            top: 115px;
            left: 20px;
            width: 70px;
            font-size:11px;color:#888;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .balance{position:absolute;top:20px;right:20px;background:#fff;border:1px solid #ff5a5a;border-radius:12px;padding:8px 12px;font-family:'Courier New',monospace;font-size:16px;color:#ff2a2a;text-shadow:0 0 2px #ffbbbb;letter-spacing:1px;z-index:101;box-shadow:0 4px 6px rgba(0,0,0,.05)}
        
        /* Shared Progress Containers */
        .progress-group-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 90%;
            max-width: 300px;
            z-index: 102;
        }
        .daily-progress-container, .spin-progress-container {
            background: #fff;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            text-align: center;
            border-left: 5px solid #4a90e2; 
        }
        .spin-progress-container {
            border-left: 5px solid #ff8c00; 
        }
        .daily-progress-text, .spin-progress-text {font-size:14px;color:#333;margin-bottom:4px; font-weight: bold;}
        .daily-progress-bar, .spin-progress-bar {width:100%;height:12px;background:rgba(0,0,0,.1);border-radius:10px;overflow:hidden;margin-top:6px}
        .daily-progress-fill {height:100%;background:linear-gradient(90deg,#00f2fe,#4facfe);border-radius:10px;width:0%;transition:width .4s ease}
        .spin-progress-fill {height:100%;background:linear-gradient(90deg,#ff8c00, #ff4500);border-radius:10px;width:0%;transition:width .4s ease}

        /* Button Adjustments */
        .button-container{
            position:absolute;bottom:40px;left:50%;transform:translateX(-50%);
            display:flex;gap:15px;z-index:103;
        }
        .action-button{
            background: linear-gradient(45deg, #4a90e2, #50b3e8); 
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,.2);
            transition: all .3s ease;
            text-transform: uppercase;
        }
        .action-button:hover{transform: translateY(-2px);box-shadow: 0 6px 20px rgba(0,0,0,.3)}
        .action-button:active{transform: translateY(0);box-shadow: 0 2px 10px rgba(0,0,0,.2)}
        .action-button:disabled{background: #ccc;cursor:not-allowed;box-shadow: none;transform: none;}
        
        .spin-button{
             background: linear-gradient(45deg, #ff8c00, #ff4500); 
             border: 2px solid #fff;
             box-shadow: 0 0 20px rgba(255,140,0,0.5);
        }

        /* Modals and Overlays */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Controlled by JS */
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .modal-content input, .modal-content button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        .modal-content button {
            background: linear-gradient(45deg, #4a90e2, #50b3e8);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        .modal-content button:hover {
            background: linear-gradient(45deg, #50b3e8, #4a90e2);
        }
        .modal-content .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            color: #aaa;
            cursor: pointer;
        }

        /* Profile Modal specific styles */
        .profile-info {
            text-align: right;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .profile-info div {
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .profile-info div:last-child {
            border-bottom: none;
        }
        .profile-info span:first-child {
            font-weight: bold;
            color: #555;
            flex-grow: 1;
            text-align: right;
        }
        .profile-info span:last-child {
            color: #2c3e50;
            font-family: 'Courier New', monospace;
            font-size: 15px;
        }
        .referral-link-container {
            margin-top: 15px;
            text-align: left;
        }
        .referral-link {
            word-break: break-all;
            background: #eee;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            color: #27ae60;
        }
        .copy-button {
            background: #27ae60 !important;
            margin-top: 10px;
        }
        .copy-button:hover {
            background: #2ecc71 !important;
        }

        /* Withdrawal History */
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            text-align: right;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .item-status {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 5px;
        }
        .status-pending { background-color: #f39c12; color: #fff; }
        .status-completed { background-color: #27ae60; color: #fff; }
        .status-failed { background-color: #e74c3c; color: #fff; }
        .item-date {
            color: #7f8c8d;
            font-size: 12px;
        }

        /* Spin Wheel Section */
        .spin-wheel-container {
            width: 90%;
            max-width: 300px;
            position: relative;
            margin: 0 auto;
        }
        .wheel {
            width: 100%;
            height: 300px;
            border-radius: 50%;
            border: 8px solid #333;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1); /* Custom slow-out curve */
        }
        .wheel-sector {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            background-color: #fff;
            border: 1px solid #333;
            overflow: hidden;
        }
        .wheel-sector::before {
            content: attr(data-label);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            font-size: 18px;
            font-weight: bold;
            color: #333;
            z-index: 2;
        }
        
        .sector-0 { background: #FFD700; transform: rotate(0deg) skewY(-36deg); }
        .sector-1 { background: #FF4500; transform: rotate(72deg) skewY(-36deg); }
        .sector-2 { background: #00FF7F; transform: rotate(144deg) skewY(-36deg); }
        .sector-3 { background: #4169E1; transform: rotate(216deg) skewY(-36deg); }
        .sector-4 { background: #FFD700; transform: rotate(288deg) skewY(-36deg); }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            border: 5px solid #fff;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 20px solid #ff2a2a;
            z-index: 11;
        }

        .spin-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 50px; 
            flex-grow: 1;
        }

        /* Banned User Alert */
        .banned-alert {
            position: fixed;
            inset: 0;
            background: rgba(179, 36, 36, 0.95); /* Deep Red/Maroon */
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 20px;
            z-index: 5000;
        }
        .banned-alert.visible {
            display: flex;
        }
        .banned-alert h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            animation: shake 0.5s infinite;
        }
        .banned-alert p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* Error Modal for Action ID */
        .action-id-error-modal {
            background-color: #fcebeb; 
            border: 2px solid #e74c3c;
            color: #c0392b;
        }
        .action-id-error-modal h3 {
             color: #c0392b;
        }


    </style>
</head>
<body>

    <div id="bannedAlert" class="banned-alert">
        <h1>‚õî ÿ™ŸÖ ÿßŸÑÿ≠ÿ∏ÿ± ‚õî</h1>
        <p>ŸÑŸÇÿØ ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿ≠ÿ≥ÿßÿ®ŸÉ ÿ®ÿ≥ÿ®ÿ® ÿßŸÜÿ™ŸáÿßŸÉ ÿ¥ÿ±Ÿàÿ∑ ÿßŸÑÿÆÿØŸÖÿ©. ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ.</p>
        <p>ŸÑŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ±ÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä.</p>
    </div>
    
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <h2 class="loading-text">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</h2>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="percentage" class="percentage">0%</div>
        </div>
    </div>
    
    <div id="appScreen" class="app-screen">
        
        <div class="user-circle" onclick="showProfileModal()">
             <span class="placeholder">ÿµŸàÿ±ÿ©</span>
             <img id="userPhoto" src="" alt="User Photo" style="display:none;">
        </div>
        <div id="userUsername" class="user-username">Username</div>
        <div id="userId" class="user-id">ID: 000</div>
        
        <div id="balance" class="balance">0 SHIB</div>

        <div class="main-content">
            
            <div class="progress-group-container">
                
                <div class="daily-progress-container">
                    <div class="daily-progress-text">ŸÖÿ¥ÿßŸáÿØÿßÿ™ ÿßŸÑŸäŸàŸÖ (<span id="adsCount">0</span>/<span id="adsLimit">100</span>)</div>
                    <div class="daily-progress-bar">
                        <div id="adsProgressFill" class="daily-progress-fill"></div>
                    </div>
                </div>

                <div class="spin-progress-container">
                    <div class="spin-progress-text">ŸÑŸÅÿßÿ™ ÿßŸÑŸäŸàŸÖ (<span id="spinsCount">0</span>/<span id="spinsLimit">15</span>)</div>
                    <div class="spin-progress-bar">
                        <div id="spinsProgressFill" class="spin-progress-fill"></div>
                    </div>
                </div>
            </div>

            <div id="spinSection" class="spin-section" style="display:none;">
                 <div class="spin-wheel-container">
                    <div class="wheel-pointer"></div>
                    <div id="wheel" class="wheel">
                        <div class="wheel-sector sector-0" style="transform: rotate(0deg) skewY(-54deg);" data-label="5 SHIB"></div>
                        <div class="wheel-sector sector-1" style="transform: rotate(72deg) skewY(-54deg);" data-label="10 SHIB"></div>
                        <div class="wheel-sector sector-2" style="transform: rotate(144deg) skewY(-54deg);" data-label="15 SHIB"></div>
                        <div class="wheel-sector sector-3" style="transform: rotate(216deg) skewY(-54deg);" data-label="20 SHIB"></div>
                        <div class="wheel-sector sector-4" style="transform: rotate(288deg) skewY(-54deg);" data-label="5 SHIB"></div>
                        <div class="wheel-center"></div>
                    </div>
                 </div>
            </div>

        </div>

        <div id="buttonContainer" class="button-container">
            <button id="watchAdsButton" class="action-button" onclick="watchAds()">
                <span id="adsButtonText">ŸÖÿ¥ÿßŸáÿØÿ© ÿ•ÿπŸÑÿßŸÜ (<span id="adReward">3</span>)</span>
            </button>
            <button id="spinButton" class="action-button spin-button" onclick="startSpin()" disabled>
                <span id="spinButtonText">ŸÑŸÅ ÿßŸÑÿπÿ¨ŸÑÿ©</span>
            </button>
        </div>
    </div>
    
    <div id="profileModalOverlay" class="modal-overlay" onclick="closeModal(event)">
        <div id="profileModalContent" class="modal-content">
            <button class="close-button" onclick="closeModal(event)">&times;</button>
            <h3>ŸÖŸÑŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h3>
            
            <div class="profile-info">
                <div><span>ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä:</span> <span id="modalBalance">0 SHIB</span></div>
                <div><span>ÿπÿØÿØ ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™:</span> <span id="modalReferrals">0</span></div>
            </div>

            <button class="action-button" style="background: #e74c3c;" onclick="showWithdrawModal()">ÿ≥ÿ≠ÿ® ÿßŸÑÿ±ÿµŸäÿØ</button>
            
            <details>
                <summary style="font-weight: bold; margin: 15px 0; color: #4a90e2; cursor: pointer; text-align: right;">ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≥ÿ≠ÿ®</summary>
                <div id="withdrawalHistory" class="history-list">
                    </div>
            </details>

            <div class="referral-link-container">
                <p style="font-weight: bold; margin-bottom: 5px; color: #555; text-align: right;">ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©:</p>
                <div id="referralLink" class="referral-link"></div>
                <button class="action-button copy-button" onclick="copyReferralLink()">ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑</button>
            </div>
        </div>
    </div>

    <div id="withdrawModalOverlay" class="modal-overlay" onclick="closeModal(event)">
        <div id="withdrawModalContent" class="modal-content">
            <button class="close-button" onclick="closeModal(event)">&times;</button>
            <h3>ÿ∑ŸÑÿ® ÿ≥ÿ≠ÿ® ÿßŸÑÿ±ÿµŸäÿØ</h3>
            <p style="margin-bottom: 15px; font-size: 14px; color: #666; text-align: right;">ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑÿ≥ÿ≠ÿ®: 400 SHIB</p>
            
            <input type="number" id="withdrawAmount" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ±ÿßÿØ ÿ≥ÿ≠ÿ®Ÿá (SHIB)" value="400">
            <input type="text" id="binanceId" placeholder="ŸÖÿπÿ±ŸëŸÅ ÿ®ŸäŸÜÿßŸÜÿ≥ (Binance ID)">
            
            <button id="confirmWithdrawButton" onclick="confirmWithdraw()">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≥ÿ≠ÿ®</button>
        </div>
    </div>

    <script>
        const API_ENDPOINT = '/api/index.js'; // Vercel Serverless Function
        let isSpinning = false;
        
        // --- Global State ---
        let globalState = {
            user_id: null,
            initData: null,
            username: null,
            userPhotoUrl: null,
            balance: 0,
            ads_watched_today: 0,
            spins_today: 0,
            is_banned: false,
            referrals_count: 0,
            withdrawal_history: [],
            ref_by: null // Used only for registration
        };

        const ADS_LIMIT = 100;
        const SPINS_LIMIT = 15;
        const REWARD_PER_AD = 3; 

        // --- Helper: Update State and UI ---
        function updateState(newState) {
            globalState = { ...globalState, ...newState };
            renderUI();
        }

        // --- Helper: Render UI ---
        function renderUI() {
            if (globalState.is_banned) {
                document.getElementById('bannedAlert').classList.add('visible');
                document.getElementById('appScreen').classList.remove('visible');
                return;
            } else {
                 document.getElementById('bannedAlert').classList.remove('visible');
            }

            // Balance
            document.getElementById('balance').textContent = `${globalState.balance.toLocaleString()} SHIB`;
            document.getElementById('modalBalance').textContent = `${globalState.balance.toLocaleString()} SHIB`;

            // Ads Progress
            const adsRatio = globalState.ads_watched_today / ADS_LIMIT;
            document.getElementById('adsCount').textContent = globalState.ads_watched_today;
            document.getElementById('adsLimit').textContent = ADS_LIMIT;
            document.getElementById('adsProgressFill').style.width = `${Math.min(adsRatio * 100, 100)}%`;
            document.getElementById('adReward').textContent = REWARD_PER_AD;

            // Spins Progress
            const spinsRatio = globalState.spins_today / SPINS_LIMIT;
            document.getElementById('spinsCount').textContent = globalState.spins_today;
            document.getElementById('spinsLimit').textContent = SPINS_LIMIT;
            document.getElementById('spinsProgressFill').style.width = `${Math.min(spinsRatio * 100, 100)}%`;
            
            // Button Status
            const watchAdsButton = document.getElementById('watchAdsButton');
            if (globalState.ads_watched_today >= ADS_LIMIT || isSpinning) {
                watchAdsButton.disabled = true;
                watchAdsButton.textContent = `ÿßŸÜÿ™ŸáŸâ ÿ≠ÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸäŸàŸÖŸä`;
            } else {
                watchAdsButton.disabled = false;
                watchAdsButton.textContent = `ŸÖÿ¥ÿßŸáÿØÿ© ÿ•ÿπŸÑÿßŸÜ (${REWARD_PER_AD})`;
            }

            const spinButton = document.getElementById('spinButton');
            if (globalState.spins_today >= SPINS_LIMIT || isSpinning) {
                spinButton.disabled = true;
                spinButton.textContent = `ÿßŸÜÿ™ŸáŸâ ÿ≠ÿØ ÿßŸÑŸÑŸÅÿßÿ™ ÿßŸÑŸäŸàŸÖŸä`;
            } else {
                spinButton.disabled = false;
                spinButton.textContent = `ŸÑŸÅ ÿßŸÑÿπÿ¨ŸÑÿ©`;
            }

            // User Info
            document.getElementById('userUsername').textContent = globalState.username || 'N/A';
            document.getElementById('userId').textContent = `ID: ${globalState.user_id}`;
            const userPhoto = document.getElementById('userPhoto');
            const placeholder = document.querySelector('.user-circle .placeholder');
            if (globalState.userPhotoUrl) {
                userPhoto.src = globalState.userPhotoUrl;
                userPhoto.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                 userPhoto.style.display = 'none';
                 placeholder.style.display = 'block';
            }

            // Referral Link
            const refLink = `https://t.me/${Telegram.WebApp.initDataUnsafe.chat.username}?start=${globalState.user_id}`;
            document.getElementById('referralLink').textContent = refLink;
            document.getElementById('modalReferrals').textContent = globalState.referrals_count;
        }

        // --- Helper: API Fetch with Error Handling ---
        async function fetchApi(payload) {
            Telegram.WebApp.showProgress();
            
            // Append essential data for all requests
            payload.user_id = globalState.user_id;
            payload.initData = globalState.initData;
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 409 || response.status === 408) { // Conflict or Timeout for Action ID
                         Telegram.WebApp.showAlert(`üîí TOKEN ERROR üîí\\n\\n[STATUS] ${data.error || 'Server Token failed verification or expired. Please try again.'}`);
                    } else if (response.status === 429) { // Rate Limit
                         Telegram.WebApp.showAlert(`üõë RATE LIMIT üõë\\n\\n[STATUS] ${data.error || 'Too many requests. Please wait before trying again.'}`);
                    } else if (response.status === 403) { // Banned or Limit Reached
                        if (data.error && data.error.includes('banned')) {
                             updateState({ is_banned: true }); // Trigger Banned UI
                        }
                        Telegram.WebApp.showAlert(`‚ùå ERROR ‚ùå\\n\\n[STATUS] ${data.error || 'An action-specific error occurred.'}`);
                    } else {
                        Telegram.WebApp.showAlert(`‚ùå API ERROR (${response.status}) ‚ùå\\n\\n[STATUS] ${data.error || 'Something went wrong on the server.'}`);
                    }
                    return { ok: false, data: data };
                }

                return data;

            } catch (error) {
                Telegram.WebApp.showAlert(`üåê NETWORK ERROR üåê\\n\\n[STATUS] Could not connect to the server: ${error.message}`);
                return { ok: false, data: { error: error.message } };
            } finally {
                Telegram.WebApp.hideProgress();
            }
        }
        
        // --- üîí Security: Action ID Request ---
        async function requestActionId(actionType) {
             const result = await fetchApi({
                type: 'generateActionId',
                action_type: actionType
             });
             
             if (result.ok && result.data.action_id) {
                 return result.data.action_id;
             }
             
             // If requesting the ID itself fails, show a generic error
             if (!result.ok) {
                 Telegram.WebApp.showAlert(`üîí Security Token Error üîí\\n\\n[STATUS] Failed to get security token for ${actionType}. Try again.`);
             }

             return null;
        }


        // --- Load/Init Functions ---

        /**
         * 1. Initializes Telegram WebApp and global state.
         * 2. Registers user (if new) or loads existing data.
         */
        async function initDailyProgress() {
            const user = Telegram.WebApp.initDataUnsafe.user;
            const refBy = Telegram.WebApp.initDataUnsafe.start_param;

            if (!user) {
                Telegram.WebApp.showAlert('‚ùå INIT ERROR ‚ùå\\n\\n[STATUS] Could not retrieve user data from Telegram.');
                return;
            }

            // Set Initial Global State
            updateState({
                user_id: user.id,
                initData: Telegram.WebApp.initData,
                username: user.username || user.first_name,
                userPhotoUrl: user.photo_url || null,
                ref_by: refBy // Only used for the first-time registration API call
            });
            
            // 1. Request Action ID for Registration (First-time critical action)
            const actionId = await requestActionId('register');
            if (!actionId) {
                // Cannot proceed if Action ID fails
                Telegram.WebApp.showAlert('‚ùå INITIALIZATION FAILED ‚ùå\\n\\n[STATUS] Failed to obtain security token for registration. Please relaunch the app.');
                return;
            }

            // 2. Register/Update User Data
            const registrationResult = await fetchApi({
                type: 'register',
                ref_by: refBy,
                action_id: actionId // Send Action ID
            });
            
            if (!registrationResult.ok) {
                Telegram.WebApp.showAlert(`‚ùå REGISTRATION ERROR ‚ùå\\n\\n[STATUS] Failed to register user: ${registrationResult.data.error}`);
                // If banned, loadUserData will handle the UI
            }

            // 3. Load all user data and display the app
            await loadUserData();

            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.add('visible');
            Telegram.WebApp.ready();
            Telegram.WebApp.MainButton.hide(); // Hide main button by default
        }

        async function loadUserData() {
            const result = await fetchApi({ type: 'getUserData' });

            if (result.ok) {
                const data = result.data;
                updateState({
                    balance: data.balance || 0,
                    ads_watched_today: data.ads_watched_today || 0,
                    spins_today: data.spins_today || 0,
                    is_banned: data.is_banned || false,
                    referrals_count: data.referrals_count || 0,
                    withdrawal_history: data.withdrawal_history || []
                });
            } else {
                 // Error handled in fetchApi
            }
        }
        
        // --- Action Handlers ---

        /**
         * Handle Watch Ad Action
         */
        async function watchAds() {
            if (globalState.ads_watched_today >= ADS_LIMIT) {
                Telegram.WebApp.showAlert('‚ö†Ô∏è LIMIT REACHED ‚ö†Ô∏è\\n\\n[STATUS] Daily ad limit reached.');
                return;
            }
            
            // Disable buttons during action
            isSpinning = true;
            renderUI();
            
            // 1. Request Action ID
            const actionId = await requestActionId('watchAd');
            if (!actionId) {
                isSpinning = false;
                renderUI();
                return;
            }

            // 2. Simulate Ad Watch (Delay)
            await new Promise(resolve => setTimeout(resolve, 3000)); 

            // 3. Send API Request
            const result = await fetchApi({
                type: 'watchAd',
                action_id: actionId // Send Action ID
            });

            if (result.ok) {
                const data = result.data;
                updateState({
                    balance: data.new_balance,
                    ads_watched_today: data.new_ads_count
                });
                Telegram.WebApp.showNotification({
                    message: `‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${data.actual_reward} SHIB ÿ•ŸÑŸâ ÿ±ÿµŸäÿØŸÉ.`,
                    type: 'success'
                });
                
                // 4. Send Commission (Fire-and-Forget, no need to wait or check result here)
                // This is triggered from the client, but the server handles security/limits.
                fetchApi({ type: 'commission', referrer_id: globalState.ref_by, referee_id: globalState.user_id });
                
            } else {
                // If API fails (e.g., rate limit, server error), the error is shown in fetchApi
            }
            
            // Re-enable buttons
            isSpinning = false;
            renderUI();
        }

        // --- Spin Wheel Logic ---
        const PRIZE_SECTORS = [5, 10, 15, 20, 5];
        const BASE_ROTATIONS = 5 * 360; // 5 full spins
        const SECTOR_ANGLE = 360 / PRIZE_SECTORS.length; // 72 degrees per sector

        function getRotationForIndex(prizeIndex) {
            // Find the center of the winning sector
            const centerAngle = (PRIZE_SECTORS.length - prizeIndex) * SECTOR_ANGLE - (SECTOR_ANGLE / 2);
            // Add a slight random offset within the sector (-25 to +25 degrees)
            const randomOffset = Math.random() * (SECTOR_ANGLE - 10) + 5; // To make it more natural
            const rotation = BASE_ROTATIONS + centerAngle + randomOffset;
            return rotation;
        }
        
        /**
         * 1. Request spin pre-check (increment spin count on server)
         */
        async function startSpin() {
            if (globalState.spins_today >= SPINS_LIMIT || isSpinning) {
                Telegram.WebApp.showAlert('‚ö†Ô∏è LIMIT REACHED ‚ö†Ô∏è\\n\\n[STATUS] Daily spin limit reached.');
                return;
            }
            
            // Disable buttons
            isSpinning = true;
            renderUI();

            // 1. Request Action ID for the initial spin increment
            const actionId = await requestActionId('spin');
            if (!actionId) {
                 isSpinning = false;
                 renderUI();
                 return;
            }

            // 2. Pre-check API (This increments the spin count, but not the balance yet)
            const result = await fetchApi({ 
                type: 'spin',
                action_id: actionId // Send Action ID
            });
            
            if (!result.ok) {
                 isSpinning = false;
                 renderUI();
                 return;
            }
            
            // Pre-check success: Update client spin count and switch to wheel UI
            updateState({ spins_today: result.data.new_spins_count });
            document.getElementById('buttonContainer').style.display = 'none';
            document.getElementById('spinSection').style.display = 'flex';
            
            // 3. Simulate Ad Watch (Delay before actual spin result)
            await new Promise(resolve => setTimeout(resolve, 3000)); 
            
            // 4. Get the result and perform the spin animation
            await spinResult();
        }

        /**
         * 2. Final step: Get prize from server and apply animation
         */
        async function spinResult() {
            // 1. Request Action ID for the final prize application ‚¨ÖÔ∏è ÿ™ŸÖ ÿßŸÑÿ™ÿπÿØŸäŸÑ
            const actionId = await requestActionId('spinResult');
            if (!actionId) {
                 // If this fails, the user has already lost the spin count, but at least
                 // they didn't get the prize multiple times (best security practice).
                 isSpinning = false;
                 renderUI();
                 // Revert UI to buttons
                 document.getElementById('spinSection').style.display = 'none';
                 document.getElementById('buttonContainer').style.display = 'flex';
                 return;
            }
            
            // 2. Get Spin Result from API
            const result = await fetchApi({ 
                type: 'spinResult',
                action_id: actionId // Send Action ID
            });
            
            if (!result.ok) {
                 // Error handled in fetchApi
                 isSpinning = false;
                 renderUI();
                 // Revert UI to buttons
                 document.getElementById('spinSection').style.display = 'none';
                 document.getElementById('buttonContainer').style.display = 'flex';
                 return;
            }

            const data = result.data;
            const wheel = document.getElementById('wheel');
            const targetRotation = getRotationForIndex(data.prize_index);

            wheel.style.transition = 'transform 5s cubic-bezier(0.2, 0.8, 0.2, 1)';
            wheel.style.transform = `rotate(${targetRotation}deg)`;

            // 3. Wait for spin animation to finish
            await new Promise(resolve => setTimeout(resolve, 5500)); 

            // 4. Update UI state (balance)
            updateState({ balance: data.new_balance });

            // 5. Show prize notification
            Telegram.WebApp.showAlert(`üéâ ÿ™ŸáÿßŸÜŸäŸÜÿß! üéâ\\n\\nŸÑŸÇÿØ ŸÅÿ≤ÿ™ ÿ®ŸÄ **${data.actual_prize} SHIB**!`);

            // 6. Reset UI and state
            wheel.style.transition = 'none';
            wheel.style.transform = `rotate(${targetRotation % 360}deg)`; // Reset rotation for next spin
            
            document.getElementById('spinSection').style.display = 'none';
            document.getElementById('buttonContainer').style.display = 'flex';
            
            isSpinning = false;
            renderUI();
        }


        // --- Modal Handlers ---

        function showProfileModal() {
            document.getElementById('profileModalOverlay').style.display = 'flex';
            displayWithdrawals();
        }

        function showWithdrawModal() {
            // Hide profile modal and show withdrawal form
            document.getElementById('profileModalOverlay').style.display = 'none';
            document.getElementById('withdrawModalOverlay').style.display = 'flex';
            document.getElementById('withdrawAmount').value = '400';
            document.getElementById('binanceId').value = '';
        }

        function closeModal(event) {
            // Only close if clicking the overlay or the close button
            if (event.target.id === 'profileModalOverlay' || event.target.id === 'withdrawModalOverlay' || event.target.className === 'close-button') {
                document.getElementById('profileModalOverlay').style.display = 'none';
                document.getElementById('withdrawModalOverlay').style.display = 'none';
            }
        }

        function displayWithdrawals() {
            const historyList = document.getElementById('withdrawalHistory');
            historyList.innerHTML = '';
            
            if (globalState.withdrawal_history.length === 0) {
                 historyList.innerHTML = '<p style="text-align: center; color: #999;">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ÿ≥ÿ≠ÿ® ÿ®ÿπÿØ.</p>';
                 return;
            }

            globalState.withdrawal_history.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';

                const statusClass = item.status === 'pending' ? 'status-pending' :
                                    item.status === 'completed' ? 'status-completed' :
                                    'status-failed';
                
                const statusText = item.status === 'pending' ? 'ŸÖÿπŸÑŸëŸÇ' :
                                   item.status === 'completed' ? 'ŸÖŸÉÿ™ŸÖŸÑ' :
                                   'ŸÅÿ¥ŸÑ';

                const date = new Date(item.created_at).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });

                itemDiv.innerHTML = `
                    <span>${item.amount.toLocaleString()} SHIB</span>
                    <span class="item-date">${date}</span>
                    <span class="item-status ${statusClass}">${statusText}</span>
                `;
                historyList.appendChild(itemDiv);
            });
        }
        
        async function confirmWithdraw() {
            const shibBalance = globalState.balance;
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const binanceId = document.getElementById('binanceId').value.trim();

            if(binanceId.length < 8 || !/^\d+$/.test(binanceId)){ Telegram.WebApp.showAlert('‚ö†Ô∏è INVALID INPUT ‚ö†Ô∏è\\n\\n[STATUS] Please enter a valid Binance User ID (minimum 8 digits).'); return; }
            if(isNaN(amount) || amount < 400){ Telegram.WebApp.showAlert('‚ö†Ô∏è INVALID AMOUNT ‚ö†Ô∏è\\n\\n[STATUS] The minimum withdrawal amount is 400 SHIB.'); return; }
            if(amount > shibBalance){ Telegram.WebApp.showAlert(`‚ùå BALANCE ERROR ‚ùå\\n\\n[STATUS] Insufficient balance. Your current balance is ${shibBalance.toLocaleString()} SHIB.`); return; }
            
            // 1. Request Action ID from the Server 
            const actionId = await requestActionId('withdraw');
            if (!actionId) return;

            // 2. Send withdrawal request via API
            const result = await fetchApi({
                type: 'withdraw',
                binanceId: binanceId,
                amount: amount,
                action_id: actionId // ‚¨ÖÔ∏è ÿ•ÿ±ÿ≥ÿßŸÑ Action ID
            });

            if (result.ok) {
                // 3. Update balance with trusted server value
                updateState({ balance: result.data.new_balance });
                
                // 4. Reload withdrawal history with new data
                await loadUserData(); 
                displayWithdrawals(); 
                
                closeModal({ target: document.getElementById('withdrawModalOverlay') }); // Close the modal
                
                Telegram.WebApp.showAlert(`‚úÖ REQUEST SENT ‚úÖ\\n\\n[DETAILS] Binance ID: ${binanceId}\\n[AMOUNT] ${amount.toLocaleString()} SHIB\\n\\nThe transfer will be processed within 24 hours.`);
            }
        }
        
        function copyReferralLink() {
            const link = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                Telegram.WebApp.showPopup({
                    title: '‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ',
                    message: 'ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ•ÿ≠ÿßŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠!',
                    buttons: [{ id: 'ok', type: 'ok', text: 'ÿ≠ÿ≥ŸÜÿßŸã' }]
                });
            }).catch(err => {
                Telegram.WebApp.showAlert('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ ‚ùå\\n\\n[STATUS] ÿ™ÿπÿ∞ÿ± ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑: ' + err);
            });
        }
        
        // --- Initialization ---
        // Ensure that the Telegram WebApp is ready before running initialization logic
        if (Telegram.WebApp.isExpanded) {
            initDailyProgress();
        } else {
             Telegram.WebApp.onEvent('ready', initDailyProgress);
        }

    </script>
</body>
</html>